---
description: 一台主机的容器总是有办法管理的，当多台主机的容器需要管理时就麻烦起来。
---

# 第4章 容器编排系统应用实践

当容器投入生产之后，我们就会自然的想到，把主机组建成一个容器集群环境，让应用镜像能充分利用容器技术的轻便快捷的特性，管理起成千上百的容器的生命周期。这样的集群系统在社区里面有很多，例如Apache Mesos，Kubernetes，Docker Swarm等，都是很优秀的容器集群系统。经过这几年的竞争和学习发展，目前业界最知名的集群套件是Kubernetes。所以本章将结合实际的集群系统的实践经验，帮助大家梳理出一些经验之谈。

## 4.1 无状态应用编排范式实践

## 4.2 有状态应用编排范式实践

## 4.3 自动扩容编排技术实战

容器集群的自动水平扩展能力一直是应用运维人员十分期待的能力，在Kubernetes还没有自动扩容能力之前，重度用户已经开始尝试通过定制化程序来实现一套容器扩容服务，其原理是通过在容器集群系统的旁路部署一个独立的自动扩容服务，监听集群节点的 CPU 、内存等性能指标，按照一定的业务规则调用Kubernetes API server调度容器进行自动扩容。当Kubernetes推出自动扩容能力的时候，主要聚焦在3个方面：水平扩容容器组\(Horizontal Pod Autoscaler \)，垂直扩容容器组\(Vertical Pod Autoscaler\)，自动扩缩集群\(Cluster Autoscaler\)。

### 4.3.1 自动扩容策略

#### 按规则扩容

按规则扩容可以根据应用的某些度量值进行扩容，以下是各个参数的含义：

* 实例数范围. 指定在自动扩容过程中，应用允许的最小的实例数和最大的实例数
* 周期间隔：自动扩容程序每隔多久检测一次应用状态
* 度量值：支持CPU，内存，QPS（响应时间），网络流量
* 周期：度量值到达条件的阈值

#### 按计划扩容

如需要在固定时间区间内操作容器扩缩，按计划扩容会更加合适。可以选择重复计划或者单次计划，在指定时间段时，自动扩容系统会调整相应的实例数。

### 4.3.2 水平扩容容器组

水平扩容容器组是通过在系统组件controller manager增加启动参数**--horizontal-pod-autoscaler-sync-period**来激活这个特性的。首先你需要安装metrics-server到集群中以提供CPU、内存等性能指标API。然后由水平扩容容器组的控制器组件定期轮询单个容器组的性指标来决策是否扩缩容器。显然只参考CPU、内存过于简单，Kubernetes提供自定义指标API来扩展监控指标的范围，让类似如业务请求量等更贴合实际的指标作为参考。

### 4.3.3 垂直扩容容器组

当容器遇到内存占满的情况下，就会需要一种优雅升级的技术，这就是垂直自动扩容技术。这个技术的规范就是在现有容器组定义的基础之上扩大CPU或者内存的使用量，以此期望故障的容器组能快速恢复正常运行状态。从应用运维的目标来看，当我们发布应用的时候是会对容器组做一些压测和预估的，但是这种性能测试是有代价的，在快速迭代的业务发展中，实际情况让我们不得不节省一下测试资源来应对业务快节奏的发展。因为，往往在运营过程中，我们会发现上线的容器组突然资源不够了，内存或者CPU的资源并的非常紧张。这个时候，如果应用了Kubernetes集群的垂直自动扩容技术就可以解决这个问题。

### 4.3.4 自动扩缩集群

随着容器业务的不断扩容，让底层的容器集群的计算节点开始出现资源紧张的情况，这个时候可以通过自动扩缩集群的能力来增加计算计算节点服务器的能力。因为物理机无法做到自动的水平扩展，此特性尤其在虚拟化云环境中被广泛应用。真正提供给客户按需分配资源。



## 4.4 总结



